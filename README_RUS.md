# Concurrent API Fetcher

## Описание

Concurrent API Fetcher — это легковесный HTTP-сервер на языке Go, предназначенный для параллельного получения данных с нескольких API-эндпоинтов. Сервер принимает список URL через POST-запрос, выполняет одновременное получение данных с каждого URL и возвращает результаты в виде JSON-массива. Проект контейнеризирован с использованием Docker для упрощения развертывания и включает обширные модульные и интеграционные тесты для обеспечения надежности.

## Возможности

- **Параллельное выполнение запросов**: Использует горутины Go и WaitGroup для одновременного получения данных с нескольких URL, что повышает производительность при массовых запросах к API.
- **Обработка ошибок**: Корректно обрабатывает некорректные URL, сетевые ошибки, таймауты и неверные JSON-данные, возвращая сообщения об ошибках в ответе.
- **Таймаут контекста**: Реализован таймаут в 5 секунд для всех API-запросов, чтобы избежать зависания на медленных или не отвечающих эндпоинтах.
- **Поддержка Docker**: Включает Dockerfile для создания минимального образа на основе Alpine и Makefile для упрощения сборки, запуска и тестирования.
- **Тестирование**: Полный набор модульных тестов (`main_test.go`) охватывает успешные запросы, некорректные URL, сетевые ошибки, ошибки чтения тела ответа и таймауты контекста. Интеграционные тесты (`test.sh`) проверяют взаимодействие с реальными API и поведение сервера.
- **Простой API**: Предоставляет два эндпоинта:
  - `GET /`: Возвращает сообщение о том, что сервер работает.
  - `POST /fetch`: Принимает JSON с массивом URL и возвращает полученные данные или ошибки.

## Структура проекта

- **Dockerfile**: Определяет многоэтапный процесс сборки с использованием `golang:1.22-alpine` для компиляции и `alpine:latest` для выполнения, обеспечивая минимальный размер образа.
- **.dockerignore**: Исключает `.git` для оптимизации контекста сборки Docker.
- **go.mod**: Указывает модуль Go и версию (`go 1.22.2`).
- **main.go**: Содержит основную логику сервера, включая обработчик главной страницы, обработчик запросов и функцию параллельного получения данных по URL.
- **main_test.go**: Включает модульные тесты для функций `fetchURL` и `fetchHandler`, охватывающие различные сценарии успеха и ошибок.
- **Makefile**: Предоставляет команды для сборки, запуска, тестирования и очистки проекта, включая операции с Docker.
- **test.sh**: Скрипт для выполнения интеграционных тестов с реальными API и проверки ответов сервера.

## Использование

1. **Клонирование репозитория**:

   ```bash
   git clone https://github.com/DaniilMarkow/ConcurrentAPIFetcher.git
   cd concurrent-api-fetcher
   ```

2. **Сборка и запуск локально**:

   ```bash
   make build
   ./workerpool
   ```

   Сервер запустится на `localhost:8080`.

3. **Запуск с Docker**:

   ```bash
   make docker_run
   ```

   Это собирает и запускает Docker-контейнер, открывая сервер на `localhost:8080`.

4. **Выполнение запроса**:
   Отправьте POST-запрос на `/fetch` с JSON, содержащим список URL:

   ```bash
   curl -X POST http://localhost:8080/fetch \
     -H "Content-Type: application/json" \
     -d '{"urls": ["https://api.publicapis.org/entries", "https://catfact.ninja/fact"]}'
   ```

   Пример ответа:

   ```json
   [
       {"url": "https://api.publicapis.org/entries", "data": "{\"entries\":[...]}", "error": ""},
       {"url": "https://catfact.ninja/fact", "data": "{\"fact\":\"Cats can jump...\"}", "error": ""}
   ]
   ```

5. **Запуск тестов**:
   - Модульные тесты: `make test`
   - Интеграционные тесты (требуется запущенный сервер): `make test_sh`
   - Интеграционные тесты в Docker: `make docker_test`
   - Покрытие кода: `make coverage`

## Эндпоинты

- **GET /**: Возвращает сообщение "Concurrent API Fetcher Server is up and running!" для подтверждения работы сервера.
- **POST /fetch**:
  - **Тело запроса**: JSON-объект с полем `urls`, содержащим массив URL (например, `{"urls": ["url1", "url2"]}`).
  - **Ответ**: JSON-массив объектов с полями `url`, `data` (тело ответа) и `error` (при наличии ошибки).
  - **Ошибки**:
    - `400 Bad Request`: Неверный JSON или пустой список URL.
    - `405 Method Not Allowed`: Запросы, отличные от POST, к `/fetch`.

## Требования

- **Go**: Версия 1.22.2 или выше.
- **Docker**: Для контейнеризированного развертывания и тестирования.
- **curl**: Для выполнения интеграционных тестов в `test.sh`.

## Команды Makefile

- `make build`: Собрать Go-бинарник.
- `make docker_build`: Собрать Docker-образ.
- `make docker_run`: Запустить Docker-контейнер.
- `make docker_stop`: Остановить и удалить контейнер.
- `make docker_logs`: Просмотреть логи контейнера.
- `make docker_test`: Выполнить интеграционные тесты в Docker.
- `make test_local`: Выполнить интеграционные тесты на локальном бинарнике.
- `make test`: Выполнить модульные тесты Go.
- `make test_sh`: Выполнить интеграционные тесты (требуется запущенный сервер).
- `make coverage`: Сгенерировать отчет о покрытии кода.
- `make clean`: Удалить собранные файлы.
- `make style`: Форматировать Go-код.
- `make help`: Показать доступные команды.

## Тестирование

- **Модульные тесты**: Охватывают `fetchURL` и `fetchHandler` для успешных случаев, некорректных URL, сетевых ошибок, ошибок чтения тела ответа, таймаутов контекста и неверных JSON-данных.
- **Интеграционные тесты**: Проверяют поведение сервера с реальными API (`https://api.publicapis.org/entries`, `https://catfact.ninja/fact` и др.), подтверждают работу главной страницы и обработку ошибок для пустых или некорректных данных.
- **Покрытие кода**: Используйте `make coverage` для создания HTML-отчета о покрытии в директории `coverage`.

## Ограничения

- Сервер имеет фиксированный таймаут в 5 секунд для всех API-запросов.
- Отсутствует аутентификация или ограничение частоты запросов.
- Поддерживаются только JSON-ответы от API; другие типы контента возвращаются как строки.
- Интеграционные тесты зависят от внешних API, которые могут быть недоступны или иметь ограничения по частоте запросов.

## Практическое применение

- **Массовое тестирование API**: Быстрое получение данных с нескольких API для тестирования или мониторинга.
- **Агрегация данных**: Параллельный сбор данных из нескольких источников для обработки или анализа.
- **Микросервисы**: Использование в качестве легковесного компонента в архитектуре микросервисов для агрегации ответов API.
